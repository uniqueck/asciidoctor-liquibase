// *** WARNING: DO NOT MODIFY *** This is a generated Java source code! 
// 
// Generated by LF-ET 2.2.1 (230520C), https://www.lohrfink.de/lfet
// From decision table
// "/opt/data/github/asciidoctor/asciidoctor-liquibase/lfet/liquibase-xml-parser.lfet"
// 21.05.2023 11:48
// 
// Changes to this code resulting from refactorings can be synchronised
// with LF-ET using the function "Scrapbook Import".
// 
// Prolog Decision Table ---->
const XMLParser = require('xml2js').Parser;
const path = require('path')
const parser = new XMLParser({preserveChildrenOrder: true, explicitArray: true, explicitRoot: false, explicitChildren: true});

function parseLiquibaseChangeSet(processModel, currentFile, elements, logger, vfs, tillTag) {

    const content = []

    for (let elementIndex = 0; elementIndex < elements.length; elementIndex++) {
        let element = elements[elementIndex]
    // Prolog Decision Table <----
    
    // Condition B01: Element = createTable
    if (
    element['#name'] === 'createTable'
    )
    {
        // Rule R01 ---->
        
        // Trace ---->
        logger.info(`liquibase-xml-parser - 20230521.114851 - 1 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
        // Trace <----
        
        // Action A01: extract Table
        //
        let tableName = element.$['tableName']
        processModel.tables.set(tableName, {columns: new Map()})
        for (let columnIndex = 0; columnIndex < element.$$.length; columnIndex++) {
            let column = element.$$[columnIndex]
            let constraints = column.constraints
            let primaryKey = constraints !== undefined ? constraints[0].$['primaryKey'] : false
            processModel.tables.get(tableName).columns.set(column.$['name'], {type: column.$['type'], primaryKey: primaryKey})
        }
        
        // Rule R01 <----
    }
    else
    {
        
        // Condition B02: Element = include
        if (
        element['#name'] === 'include'
        )
        {
            // Rule R02 ---->
            
            // Trace ---->
            logger.info(`liquibase-xml-parser - 20230521.114851 - 2 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
            // Trace <----
            
            // Action A02: follow include
            const absoluteFile = path.join('/',vfs.dirname(currentFile), element.$['file'])
            
            var includeFileElements = []
            parser.parseString(vfs.read(absoluteFile), function(err, result) {
                includeFileElements = result.$$
            });
            
            parseLiquibaseChangeSet(processModel, absoluteFile, includeFileElements, logger, vfs, tillTag)
            //
            
            // Rule R02 <----
        }
        else
        {
            
            // Condition B03: Element = changeSet
            if (
            element['#name'] === 'changeSet'
            )
            {
                // Rule R03 ---->
                
                // Trace ---->
                logger.info(`liquibase-xml-parser - 20230521.114851 - 3 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                // Trace <----
                
                // Action A03: parse changeSet
                parseLiquibaseChangeSet(processModel, currentFile, element.$$, logger, vfs, tillTag)
                
                // Rule R03 <----
            }
            else
            {
                
                // Condition B04: Element = addPrimaryKey
                if (
                element['#name'] === 'addPrimaryKey'
                )
                {
                    // Rule R04 ---->
                    
                    // Trace ---->
                    logger.info(`liquibase-xml-parser - 20230521.114851 - 4 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                    // Trace <----
                    
                    // Action A04: set primary key for column
                    let table = processModel.tables.get(element.$['tableName'])
                    let columnNames = element.$['columnNames']
                    table.columns.get(columnNames).primaryKey = true
                    
                    // Rule R04 <----
                }
                else
                {
                    
                    // Condition B05: Element = dropTable
                    if (
                    element['#name'] === 'dropTable'
                    )
                    {
                        // Rule R05 ---->
                        
                        // Trace ---->
                        logger.info(`liquibase-xml-parser - 20230521.114851 - 5 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                        // Trace <----
                        
                        // Action A05: drop Table
                        processModel.tables.delete(element.$['tableName'])
                        
                        // Rule R05 <----
                    }
                    else
                    {
                        
                        // Condition B06: Element = preConditions
                        if (
                        element['#name'] === 'preConditions'
                        )
                        {
                            // Rule R06 ---->
                            
                            // Trace ---->
                            logger.info(`liquibase-xml-parser - 20230521.114851 - 6 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                            // Trace <----
                            
                            // Action A11: ignore element
                            console.log(element)
                            //
                            
                            // Rule R06 <----
                        }
                        else
                        {
                            
                            // Condition B07: Element = sql
                            if (
                            element['#name'] === 'sql'
                            )
                            {
                                // Rule R07 ---->
                                
                                // Trace ---->
                                logger.info(`liquibase-xml-parser - 20230521.114851 - 7 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                                // Trace <----
                                
                                // Action A11: ignore element
                                console.log(element)
                                //
                                
                                // Rule R07 <----
                            }
                            else
                            {
                                
                                // Condition B08: Element = createSequence
                                if (
                                element['#name'] === 'createSequence'
                                )
                                {
                                    // Rule R08 ---->
                                    
                                    // Trace ---->
                                    logger.info(`liquibase-xml-parser - 20230521.114851 - 8 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                                    // Trace <----
                                    
                                    // Action A11: ignore element
                                    console.log(element)
                                    //
                                    
                                    // Rule R08 <----
                                }
                                else
                                {
                                    
                                    // Condition B09: Element = createProcedure
                                    if (
                                    element['#name'] === 'createProcedure'
                                    )
                                    {
                                        // Rule R09 ---->
                                        
                                        // Trace ---->
                                        logger.info(`liquibase-xml-parser - 20230521.114851 - 9 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                                        // Trace <----
                                        
                                        // Action A11: ignore element
                                        console.log(element)
                                        //
                                        
                                        // Rule R09 <----
                                    }
                                    else
                                    {
                                        
                                        // Condition B10: Element = renameColumn
                                        if (
                                        element['#name'] === 'renameColumn'
                                        )
                                        {
                                            // Rule R10 ---->
                                            
                                            // Trace ---->
                                            logger.info(`liquibase-xml-parser - 20230521.114851 - 10 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                                            // Trace <----
                                            
                                            // Action A06: rename Column
                                            let tableName = element.$['tableName']
                                            let oldColumnName = element.$['oldColumnName']
                                            let newColumnName = element.$['newColumnName']
                                            let table = processModel.tables.get(tableName)
                                            let column = table.columns.get(oldColumnName)
                                            table.columns.set(newColumnName, column)
                                            table.columns.delete(oldColumnName)
                                            
                                            // Rule R10 <----
                                        }
                                        else
                                        {
                                            
                                            // Condition B11: Element = comment
                                            if (
                                            element['#name'] === 'comment'
                                            )
                                            {
                                                // Rule R11 ---->
                                                
                                                // Trace ---->
                                                logger.info(`liquibase-xml-parser - 20230521.114851 - 11 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                                                // Trace <----
                                                
                                                // Action A11: ignore element
                                                console.log(element)
                                                //
                                                
                                                // Rule R11 <----
                                            }
                                            else
                                            {
                                                
                                                // Condition B12: Element = addColumn
                                                if (
                                                element['#name'] === 'addColumn'
                                                )
                                                {
                                                    // Rule R12 ---->
                                                    
                                                    // Trace ---->
                                                    logger.info(`liquibase-xml-parser - 20230521.114851 - 12 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                                                    // Trace <----
                                                    
                                                    // Action A07: add Column
                                                    //
                                                    let tableName = element.$['tableName']
                                                    let table = processModel.tables.get(tableName)
                                                    let columns = element.column
                                                    columns.forEach((column) => {
                                                        let columnName = column.$['name']
                                                        let type = column.$['type']
                                                        table.columns.set(columnName, {type: type, primaryKey: false})
                                                    })
                                                    
                                                    // Rule R12 <----
                                                }
                                                else
                                                {
                                                    
                                                    // Condition B13: Element = dropColumn
                                                    if (
                                                    element['#name'] === 'dropColumn'
                                                    )
                                                    {
                                                        // Rule R13 ---->
                                                        
                                                        // Trace ---->
                                                        logger.info(`liquibase-xml-parser - 20230521.114851 - 13 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                                                        // Trace <----
                                                        
                                                        // Action A08: drop Column
                                                        let tableName = element.$['tableName']
                                                        let columnName = element.$['columnName']
                                                        processModel.tables.get(tableName).columns.delete(columnName)
                                                        
                                                        // Rule R13 <----
                                                    }
                                                    else
                                                    {
                                                        
                                                        // Condition B14: Element = rollback
                                                        if (
                                                        element['#name'] === 'rollback'
                                                        )
                                                        {
                                                            // Rule R14 ---->
                                                            
                                                            // Trace ---->
                                                            logger.info(`liquibase-xml-parser - 20230521.114851 - 14 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                                                            // Trace <----
                                                            
                                                            // Action A11: ignore element
                                                            console.log(element)
                                                            //
                                                            
                                                            // Rule R14 <----
                                                        }
                                                        else
                                                        {
                                                            
                                                            // Condition B15: Element = dropSequence
                                                            if (
                                                            element['#name'] === 'dropSequence'
                                                            )
                                                            {
                                                                // Rule R15 ---->
                                                                
                                                                // Trace ---->
                                                                logger.info(`liquibase-xml-parser - 20230521.114851 - 15 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                                                                // Trace <----
                                                                
                                                                // Action A11: ignore element
                                                                console.log(element)
                                                                //
                                                                
                                                                // Rule R15 <----
                                                            }
                                                            else
                                                            {
                                                                
                                                                // Condition B16: Element = addUniqueConstraint
                                                                if (
                                                                element['#name'] === 'addUniqueConstraint'
                                                                )
                                                                {
                                                                    // Rule R16 ---->
                                                                    
                                                                    // Trace ---->
                                                                    logger.info(`liquibase-xml-parser - 20230521.114851 - 16 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                                                                    // Trace <----
                                                                    
                                                                    // Action A11: ignore element
                                                                    console.log(element)
                                                                    //
                                                                    
                                                                    // Rule R16 <----
                                                                }
                                                                else
                                                                {
                                                                    
                                                                    // Condition B17: Element = addForeignKeyConstraint
                                                                    if (
                                                                    element['#name'] === 'addForeignKeyConstraint'
                                                                    )
                                                                    {
                                                                        // Rule R17 ---->
                                                                        
                                                                        // Trace ---->
                                                                        logger.info(`liquibase-xml-parser - 20230521.114851 - 17 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                                                                        // Trace <----
                                                                        
                                                                        // Action A09: addForeignKeyConstraint
                                                                        let baseTableName = element.$['baseTableName']
                                                                        let baseColumnName = element.$['baseColumnNames']
                                                                        let referencedTableName = element.$['referencedTableName']
                                                                        let referencedColumnName = element.$['referencedColumnNames']
                                                                        processModel.tables.get(baseTableName).columns.get(baseColumnName).referencedTable = referencedTableName
                                                                        processModel.tables.get(baseTableName).columns.get(baseColumnName).referencedColumn = referencedColumnName
                                                                        // Rule R17 <----
                                                                    }
                                                                    else
                                                                    {
                                                                        
                                                                        // Condition B18: Element = tagDatabase
                                                                        if (
                                                                        element['#name'] === 'tagDatabase'
                                                                        )
                                                                        {
                                                                            
                                                                            // Condition B19: tag = tillTag
                                                                            if (
                                                                            tillTag === element.$['#tag']
                                                                            )
                                                                            {
                                                                                // Rule R18 ---->
                                                                                
                                                                                // Trace ---->
                                                                                logger.info(`liquibase-xml-parser - 20230521.114851 - 18 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                                                                                // Trace <----
                                                                                
                                                                                // Action A13: finish parsing
                                                                                processModel.finshedProcessing = true
                                                                                //
                                                                                
                                                                                // Rule R18 <----
                                                                            }
                                                                            else
                                                                            {
                                                                                // Rule R19 ---->
                                                                                
                                                                                // Trace ---->
                                                                                logger.info(`liquibase-xml-parser - 20230521.114851 - 19 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                                                                                // Trace <----
                                                                                
                                                                                // Action A12: skip tag
                                                                                logger.warn(`skip tag '${element['#name']}'`);
                                                                                
                                                                                // Rule R19 <----
                                                                            }
                                                                        }
                                                                        else
                                                                        {
                                                                            // Rule R20 ---->
                                                                            
                                                                            // Trace ---->
                                                                            logger.info(`liquibase-xml-parser - 20230521.114851 - 20 / 20 - ${currentFile} - ${JSON.stringify(processModel)}`)
                                                                            // Trace <----
                                                                            
                                                                            // Action A10: log unsupported element
                                                                            logger.warn(`Unsupported liquibase element '${element['#name']}' detected`)
                                                                            
                                                                            // Rule R20 <----
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    
    // Epilog Decision Table ---->
}
    return content
}

module.exports = {
  parseLiquibaseChangeSet: (processModel, currentFile, elements, logger, vfs, tillTag) => {
    return parseLiquibaseChangeSet(processModel, currentFile, elements, logger, vfs, tillTag)
  }
}
// Epilog Decision Table <----

// End of generated Java source code
// Generated by LF-ET 2.2.1 (230520C), https://www.lohrfink.de/lfet

